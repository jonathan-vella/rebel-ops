# Sync Template from Upstream Repository
# Keeps this skeleton template in sync with azure-agentic-infraops
# Runs weekly and creates a PR with changes for review

name: Sync from Upstream

on:
  schedule:
    # Run every Monday at 06:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (show changes without creating PR)"
        required: false
        default: false
        type: boolean

env:
  UPSTREAM_REPO: "jonathan-vella/azure-agentic-infraops"
  UPSTREAM_BRANCH: "main"

jobs:
  sync:
    name: Sync from upstream
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone upstream repository
        run: |
          git clone --depth 1 --branch ${{ env.UPSTREAM_BRANCH }} \
            https://github.com/${{ env.UPSTREAM_REPO }}.git upstream

      - name: Sync files from upstream
        run: |
          echo "üîÑ Syncing files from upstream repository..."
          echo ""
          echo "Using exclusion-based sync - all content synced EXCEPT blocklist"
          echo ""

          # Exclusion-based sync: sync everything EXCEPT specific paths
          # This ensures new folders/files are automatically picked up
          # Note: rsync exit code 24 ("files vanished") is harmless and ignored
          rsync -av \
            --exclude='.git/' \
            --exclude='scenarios/' \
            --exclude='docs/' \
            --exclude='agent-output/*/' \
            --exclude='infra/bicep/*/' \
            --exclude='README.md' \
            --exclude='TEMPLATE-README.md' \
            --exclude='USAGE-PROMPT.md' \
            --exclude='CONTRIBUTING.md' \
            --exclude='CHANGELOG.md' \
            --exclude='.github/workflows/' \
            upstream/ ./ || [ $? -eq 24 ]

          # Sync specific README files we want to keep updated
          echo ""
          echo "üìÑ Syncing template README files..."
          if [ -f "upstream/agent-output/README.md" ]; then
            cp upstream/agent-output/README.md agent-output/README.md
            echo "  ‚úì agent-output/README.md"
          fi
          if [ -f "upstream/infra/bicep/README.md" ]; then
            mkdir -p infra/bicep
            cp upstream/infra/bicep/README.md infra/bicep/README.md
            echo "  ‚úì infra/bicep/README.md"
          fi

          # Cleanup upstream clone
          rm -rf upstream/

          echo ""
          echo "‚úÖ Sync complete"

      - name: Post-sync cleanup
        run: |
          echo "üßπ Running post-sync cleanup..."

          # Remove any archive folders that shouldn't be in template
          find . -type d -name ".archive" -exec rm -rf {} + 2>/dev/null || true

          # Remove any scenario-specific content that may have leaked
          rm -rf scenarios/ 2>/dev/null || true
          rm -rf .bicep-planning-files/ 2>/dev/null || true

          echo "‚úÖ Cleanup complete"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected - template is up to date"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git diff --stat
            git status --short
          fi

      - name: Show diff (dry run)
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "üîç DRY RUN - Changes that would be applied:"
          git diff --stat
          echo ""
          echo "üìã Modified files:"
          git status --short

      - name: Get upstream version
        id: version
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          if [ -f "VERSION.md" ]; then
            VERSION=$(grep -oP '(?<=\*\*Current Version:\*\* )\d+\.\d+\.\d+' VERSION.md | head -1 || echo "unknown")
            # Fallback to old format if new format not found
            if [ "$VERSION" = "unknown" ]; then
              VERSION=$(grep -oP '(?<=## Version )\d+\.\d+\.\d+' VERSION.md | head -1 || echo "unknown")
            fi
          else
            VERSION="unknown"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Upstream version: $VERSION"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync from upstream v${{ steps.version.outputs.version }}"
          title: "chore: Sync from upstream (v${{ steps.version.outputs.version }})"
          body: |
            ## üîÑ Upstream Sync

            This PR syncs the template repository with the latest changes from
            [azure-agentic-infraops](${{ github.server_url }}/${{ env.UPSTREAM_REPO }}).

            ### Upstream Version
            **${{ steps.version.outputs.version }}**

            ### Sync Strategy
            **Exclusion-based sync** - All content is synced EXCEPT the blocklist below.
            This ensures new folders and files are automatically picked up.

            ### Excluded from Sync
            | Path | Reason |
            |------|--------|
            | `scenarios/` | Demo scenarios (main repo only) |
            | `docs/` | Template maintains its own documentation |
            | `.github/workflows/` | Template maintains its own workflows |
            | `agent-output/*/` | Example project outputs (README synced) |
            | `infra/bicep/*/` | Example Bicep templates (README synced) |
            | `README.md` | Template has its own README |
            | `CONTRIBUTING.md` | Main repo contribution guide |
            | `CHANGELOG.md` | Main repo changelog |

            ### Review Checklist
            - [ ] Review changed files for unexpected content
            - [ ] No scenario-specific content leaked through
            - [ ] All agent definitions work correctly
            - [ ] Dev container builds successfully
            - [ ] Root config files are appropriate for template

            ---
            *Auto-generated by the upstream sync workflow*
          branch: "chore/sync-upstream-${{ steps.version.outputs.version }}"
          labels: |
            sync
            automated
          draft: false
