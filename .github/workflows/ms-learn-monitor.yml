name: Microsoft Learn Link Monitor

on:
  schedule:
    - cron: "0 9 * * 1" # Weekly on Monday at 9:00 AM UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-ms-learn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Extract Microsoft Learn URLs with file locations
        run: |
          echo "Extracting all Microsoft Learn links with file locations..."

          # Create a file with URL and source file pairs
          > url-sources.txt

          # Find all markdown files and extract URLs with their source
          # Note: Pattern [^[:space:]")<>,]+ matches URL chars, stopping at closing delimiters
          # This avoids truncation at 's' characters (e.g., 'answers', 'paths', 'rest')
          find docs/ -name "*.md" -type f | while read file; do
            # Extract learn.microsoft.com URLs
            grep -oE 'https://learn\.microsoft\.com/[^[:space:]")<>,]+' "$file" 2>/dev/null | while read url; do
              echo "$url|$file" >> url-sources.txt
            done
            # Extract legacy docs.microsoft.com URLs
            grep -oE 'https://docs\.microsoft\.com/[^[:space:]")<>,]+' "$file" 2>/dev/null | while read url; do
              echo "$url|$file" >> url-sources.txt
            done
          done

          # Get unique URLs for checking
          cut -d'|' -f1 url-sources.txt | sort -u > ms-learn-urls.txt

          LINK_COUNT=$(wc -l < ms-learn-urls.txt)
          echo "Found $LINK_COUNT unique Microsoft Learn links"
          echo "LINK_COUNT=$LINK_COUNT" >> $GITHUB_ENV

      - name: Check each URL
        run: |
          echo "# Microsoft Learn Link Status" > link-report.md
          echo "" >> link-report.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> link-report.md
          echo "**Total Unique Links Checked:** $(wc -l < ms-learn-urls.txt)" >> link-report.md
          echo "" >> link-report.md

          BROKEN_COUNT=0
          CHECKED=0

          while read url; do
            CHECKED=$((CHECKED + 1))

            # Clean URL (remove trailing punctuation)
            clean_url=$(echo "$url" | sed 's/[,;.)]*$//' | sed 's/"$//' | sed "s/'$//")

            # Add delay every 10 requests to avoid rate limiting
            if [ $((CHECKED % 10)) -eq 0 ]; then
              sleep 1
            fi

            # Check URL with timeout
            status=$(curl -o /dev/null -s -w "%{http_code}" -L --connect-timeout 10 --max-time 30 "$clean_url" 2>/dev/null || echo "000")

            if [ "$status" != "200" ]; then
              echo "### âŒ Status $status" >> link-report.md
              echo "" >> link-report.md
              echo "**URL:** \`$clean_url\`" >> link-report.md
              echo "" >> link-report.md

              # Find files containing this URL
              echo "**Found in:**" >> link-report.md
              grep -l "$url" docs/**/*.md 2>/dev/null | head -5 | while read file; do
                echo "- \`$file\`" >> link-report.md
              done
              echo "" >> link-report.md

              BROKEN_COUNT=$((BROKEN_COUNT + 1))
            fi

            # Progress indicator
            echo "Checked $CHECKED/$(wc -l < ms-learn-urls.txt): $status - $clean_url"

          done < ms-learn-urls.txt

          echo "BROKEN_COUNT=$BROKEN_COUNT" >> $GITHUB_ENV

          if [ $BROKEN_COUNT -eq 0 ]; then
            echo "## âœ… All Microsoft Learn links are working!" >> link-report.md
          else
            echo "---" >> link-report.md
            echo "" >> link-report.md
            echo "**Summary:** $BROKEN_COUNT broken link(s) found out of $(wc -l < ms-learn-urls.txt) checked." >> link-report.md
          fi

      - name: Generate job summary
        run: |
          echo "## ðŸ”— Microsoft Learn Link Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Links Checked:** ${{ env.LINK_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Broken Links:** ${{ env.BROKEN_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ env.BROKEN_COUNT }}" != "0" ]; then
            echo "### Broken Links Report" >> $GITHUB_STEP_SUMMARY
            cat link-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All links are working!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for existing open issue
        if: env.BROKEN_COUNT != '0'
        id: check-existing
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links,microsoft-learn'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Microsoft Learn Links Need Update')
            );

            if (existingIssue) {
              console.log(`Found existing open issue #${existingIssue.number}`);
              core.setOutput('exists', 'true');
              core.setOutput('issue_number', existingIssue.number);
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Update existing issue
        if: env.BROKEN_COUNT != '0' && steps.check-existing.outputs.exists == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('link-report.md', 'utf8');
            const issueNumber = ${{ steps.check-existing.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ðŸ”„ Updated Scan Results\n\n${report}\n\n---\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });

            console.log(`Updated issue #${issueNumber} with new scan results`);

      - name: Create issue
        if: env.BROKEN_COUNT != '0' && steps.check-existing.outputs.exists == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('link-report.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Microsoft Learn Links Need Update',
              body: `${report}\n\n---\n\n**Action Required:**\n1. Search for each broken URL in the \`docs/\` folder\n2. Find the updated URL on Microsoft Learn\n3. Update the markdown files\n4. Test the new links\n\n**Note:** Microsoft Learn URLs may have been redirected, moved, or retired.\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['maintenance', 'microsoft-learn', 'broken-links']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Report success
        if: env.BROKEN_COUNT == '0'
        run: |
          echo "âœ… SUCCESS: All ${{ env.LINK_COUNT }} Microsoft Learn links are working!"
